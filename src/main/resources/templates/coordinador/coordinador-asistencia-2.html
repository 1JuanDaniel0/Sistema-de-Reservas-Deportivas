<!DOCTYPE html>
<html lang="es" class="light-style layout-compact" dir="ltr" data-theme="theme-semi-dark" data-assets-path="/" data-template="vertical-menu-template-semi-dark" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Asistencia - Coordinador</title>
    <meta name="description" content="Dashboard para coordinadores de la Municipalidad de San Miguel" />
    <meta name="keywords" content="dashboard, coordinador, asistencia, san miguel"/>
    <link rel="icon" type="image/x-icon" th:href="@{/img/icono.ico}">
    <link rel="preconnect" href="https://fonts.googleapis.com/"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" th:href="@{/vendor/fonts/boxicons.css}" />
    <link rel="stylesheet" th:href="@{/vendor/fonts/fontawesome.css}" />
    <link rel="stylesheet" th:href="@{/vendor/fonts/flag-icons.css}" />
    <link rel="stylesheet" th:href="@{/vendor/css/rtl/core.css}" class="template-customizer-core-css"/>
    <link rel="stylesheet" th:href="@{/vendor/css/rtl/theme-semi-dark.css}" class="template-customizer-theme-css"/>
    <link rel="stylesheet" th:href="@{/css/demo.css}"/>
    <link rel="stylesheet" th:href="@{/css/offcanvas-style.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/perfect-scrollbar/perfect-scrollbar.css}" />
    <link rel="stylesheet" th:href="@{/vendor/libs/sweetalert2/sweetalert2.css}">
    <link rel="stylesheet" th:href="@{/vendor/css/pages/page-profile.css}"/>
    <link rel="stylesheet" th:href="@{/vendor/css/navbar2-estilo-coordi.css}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">
    <script th:src="@{/vendor/js/helpers.js}"></script>
    <script th:src="@{/js/config.js}"></script>
</head>
<body style="background-color: #F5E8C7;">
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <div class="layout-page">
            <div th:replace="~{fragments/navbar2 :: navbarFragment2}"></div>
            <div class="content-wrapper">
                <div class="container-fluid flex-grow-1 container-p-y">
                    <!-- Mini dashboard -->
                    <div class="row">
                        <!-- Total asistencias -->
                        <div class="col-md-3 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="card-icon mb-3">
                                        <div class="avatar">
                                            <div class="avatar-initial rounded bg-label-primary">
                                                <i class='bx bx-user-check bx-sm'></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-info">
                                        <h4 class="card-title mb-2">Total Asistencias</h4>
                                        <div class="d-flex align-items-end mb-1 gap-1">
                                            <h4 class="text-primary mb-0 counter"
                                                th:attr="data-target=${totalAsistenciasMes ?: 0}"
                                                th:text="0">0</h4>
                                            <p class="mb-0">este mes</p>
                                        </div>
                                        <p class="text-muted mb-0 text-truncate">Asistencias <strong>completadas</strong> este mes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Doble asistencia -->
                        <div class="col-md-3 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="card-icon mb-3">
                                        <div class="avatar">
                                            <div class="avatar-initial rounded bg-label-success">
                                                <i class='bx bx-transfer bx-sm'></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-info">
                                        <h4 class="card-title mb-2">Doble Asistencia</h4>
                                        <div class="d-flex align-items-end mb-1 gap-1">
                                            <h4 class="text-success mb-0 counter"
                                                th:attr="data-target=${diasDobleAsistencia ?: 0}"
                                                th:text="0">0</h4>
                                            <p class="mb-0">días</p>
                                        </div>
                                        <p class="text-muted mb-0 text-truncate">Marcó <strong>entrada y salida</strong> en el día</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Porcentaje asistencia -->
                        <div class="col-md-3 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="card-icon mb-3">
                                        <div class="avatar">
                                            <div class="avatar-initial rounded bg-label-info">
                                                <i class='bx bx-calendar-check bx-sm'></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-info">
                                        <h4 class="card-title mb-2">Porcentaje</h4>
                                        <div class="d-flex align-items-end mb-1 gap-1">
                                            <h4 class="text-info mb-0 counter"
                                                th:attr="data-target=${asistenciasPorcentaje ?: 0}"
                                                th:text="0">0</h4>
                                            <p class="mb-0">%</p>
                                        </div>
                                        <p class="text-muted mb-0 text-truncate">Porcentaje de <strong>días asistidos</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Última asistencia -->
                        <div class="col-md-3 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="card-icon mb-3">
                                        <div class="avatar">
                                            <div class="avatar-initial rounded bg-label-secondary">
                                                <i class='bx bx-history bx-sm'></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-info">
                                        <h4 class="card-title mb-2">Última Asistencia</h4>
                                        <div class="d-flex align-items-end mb-1 gap-2">
                                            <h5 class="text-secondary mb-0"
                                                th:text="${ultimaAsistencia != null ? #temporals.format(ultimaAsistencia.fecha, 'EEEE dd MMMM yyyy', T(java.util.Locale).forLanguageTag('es')) : '—'}">
                                                Lunes 15 Julio 2025
                                            </h5>
                                            <span th:if="${ultimaAsistencia != null}" class="badge"
                                                  th:classappend="'bg-' + (ultimaAsistencia.estado.estado == 'Asistió' ? 'success' : 'warning')"
                                                  th:text="${ultimaAsistencia.estado.estado}">Asistió</span>
                                        </div>
                                        <p class="text-muted mb-0 text-truncate">Último registro marcado</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- / Mini dashboard -->
                    <!-- Datatable historial de asistencias -->
                    <div class="row">
                        <!-- Sección marcar asistencia-->
                        <div class="col-xl-3 col-lg-3 col-md-3">
                            <!-- Botón que abre el modal -->
                            <div class="card mb-4">
                                <h3 class="card-header card-action border-bottom">Marcar Asistencia</h3>
                                <div class="card-body text-center mt-4">
                                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalAsistencia">
                                        <i class='bx bx-map-pin me-2'></i> Marcar Asistencia
                                    </button>
                                </div>
                            </div>
                            <!-- /Sección marcar asistencia -->
                        </div>
                        <div class="col-xl-9 col-lg-9 col-md-9">
                            <div class="card card-action mb-4">
                                <div class="card-header border-bottom align-items-center">
                                    <h3 class="card-action-title mb-0">Historial de Asistencia</h3>
                                    <div class="card-action-element">
                                        <div class="dropdown">
                                            <div th:replace="~{fragments/export-dropdown :: exportDropdown('asistencia-coordinadores')}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body table-responsive mt-4">
                                    <table class="table table-striped table-bordered nowrap w-100" id="tablaAsistencias">
                                        <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Hora de Entrada</th>
                                            <th>Hora de Salida</th>
                                            <th>Geolocalización</th>
                                            <th>Estado</th>
                                        </tr>
                                        </thead>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /Datatable historial de asistencias -->
                </div>
                <div class="content-backdrop fade"></div>
            </div>
        </div>
        <div class="layout-overlay layout-menu-toggle"></div>
        <div class="drag-target"></div>
    </div>
    <!-- Offcanvas navbar para móviles -->
    <div th:replace="~{fragments/offcanvas-navbar :: offcanvasNavbar}"></div>

    <!-- Modal Marcar Asistencia -->
    <div class="modal fade" id="modalAsistencia" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <form class="modal-content border-0 shadow" id="attendanceForm" th:action="@{/coordinador/marcarAsistencia}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="latlon" id="latlon" />
                <div class="modal-header bg-label-primary pb-4 text-white">
                    <h5 class="modal-title fw-bold">
                        <i class='bx bx-map-pin me-1'></i> Marcar Asistencia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <!-- Contenedor del mapa con spinner -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Tu ubicación actual:</label>
                        <div class="position-relative border rounded overflow-hidden shadow-sm" style="height: 300px;">
                            <!-- Spinner de carga -->
                            <div id="mapLoader" class="d-flex justify-content-center align-items-center w-100 h-100 bg-white position-absolute top-0 start-0">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando mapa...</span>
                                </div>
                            </div>
                            <!-- Iframe oculto inicialmente -->
                            <iframe id="mapIframe"
                                    width="100%" height="100%" style="border:0; display: none;"
                                    loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
                        </div>
                    </div>
                    <!-- Información adicional -->
                    <div class="mb-3">
                        <label for="observacion" class="form-label fw-semibold">Observación (opcional):</label>
                        <textarea name="observacion" id="observacion" class="form-control" rows="3"
                                  placeholder="Ej. Llegué puntual, ingresé por la puerta norte..."></textarea>
                    </div>
                    <div id="locationStatus" class="text-warning small"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="submitAttendance" class="btn btn-success">
                        <i class='bx bx-check-circle'></i> <span id="attendanceAction">Confirmar</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para mostrar Google Maps de la tabla -->
    <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mapModalLabel">Ubicación en el mapa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <iframe id="mapFrame" width="100%" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    window.addEventListener("load", function () {
        const counters = document.querySelectorAll(".counter");
        const speed = 200; // aumenta este valor para hacer la animación más lenta
        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute("data-target")) || 0;
            let count = 0;
            const updateCount = () => {
                const increment = Math.max(1, Math.floor(target / speed));
                count += increment;
                if (count < target) {
                    counter.innerText = count;
                    setTimeout(updateCount, 40);
                } else {
                    counter.innerText = target;
                }
            };
            updateCount();
        });
    });
</script>
<script th:src="@{/js/offcanvas-navbar.js}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/vendor/libs/popper/popper.js}"></script>
<script th:src="@{/vendor/js/bootstrap.js}"></script>
<script th:src="@{/vendor/libs/perfect-scrollbar/perfect-scrollbar.js}"></script>
<script th:src="@{/vendor/libs/hammer/hammer.js}"></script>
<script th:src="@{/vendor/js/menu.js}"></script>
<script th:src="@{/vendor/libs/sweetalert2/sweetalert2.js}"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script th:src="@{/js/asistencia-datatables.js}"></script>
<script th:inline="javascript">
    var mensajeError = [[${session.mensajeError != null ? #strings.escapeJavaScript(session.mensajeError) : null}]];
</script>
<script th:src="@{/js/marca-asistencia.js}"></script>
<script>
    function verUbicacion(lat, lon) {
        const mapaUrl = `https://www.google.com/maps?q=${lat},${lon}&output=embed`;
        document.getElementById('mapFrame').src = mapaUrl;
        const modal = new bootstrap.Modal(document.getElementById('mapModal'));
        modal.show();
    }
</script>
</body>
</html>