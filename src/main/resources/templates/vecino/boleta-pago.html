<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Boleta de Reserva - Municipalidad de San Miguel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="/img/icono.ico">
    <link rel="icon" type="image/x-icon" th:href="@{/img/icono.ico}">
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <style>
        body {
            font-family: 'Public Sans', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #b3e5fc 50%, #81d4fa 100%);
            min-height: 100vh;
        }

        .status-pending {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow {
            from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            to { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }

        .status-confirmed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse-glow-green 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow-green {
            from {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            }
            to {
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
            }
        }

        .payment-steps {
            position: relative;
        }

        .payment-steps::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 60px;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #10b981, #34d399, #6ee7b7);
        }

        .step-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .step-pending {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #6b7280;
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 50;
            animation: bounce-float 3s ease-in-out infinite;
        }

        @keyframes bounce-float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .bank-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .bank-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">

<div class="max-w-7xl mx-auto">
    <!-- Header con estado y logo -->
    <div class="bg-white rounded-2xl shadow-2xl mb-8 overflow-hidden">
        <!-- Encabezado dinámico basado en el estado -->
        <div class="status-pending p-6"
             th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'status-confirmed' : 'status-pending'">
            <div class="flex justify-center mb-4">
                <img th:src="@{/img/logo-sanM.png}" alt="Municipalidad de San Miguel" class="h-16 md:h-20">
            </div>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-3 mb-2">
                    <i class="bx text-3xl" th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'text-green-400 bx-trophy' : 'text-white bx-clock'"></i>
                    <h1 class="text-3xl font-bold" th:text="${reserva.estado.estado == 'Confirmada'} ? '¡Reserva Confirmada!' : '¡Reserva Creada!'"></h1>
                </div>
                <p class="text-lg" th:text="${reserva.estado.estado == 'Confirmada'} ?
                   'Su reserva ha sido confirmada. ¡Disfrute su experiencia!' :
                   'Su reserva está pendiente de pago. Complete el proceso siguiente para confirmarla.'">
                </p>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">

        <!-- Columna Principal - Detalles de la Reserva -->
        <div class="lg:col-span-2 space-y-8">

            <!-- Información de la Reserva -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <!-- Header con logo institucional -->
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="bx bx-receipt text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Detalles de su Reserva</h2>
                            <p class="text-gray-600">Información completa de su solicitud</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <img th:src="@{/img/icono-sanM.png}" alt="San Miguel" class="h-12 w-12">
                        <div class="text-right">
                            <p class="text-sm font-semibold text-blue-600">Municipalidad de</p>
                            <p class="text-lg font-bold text-blue-800">San Miguel</p>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-xl">
                            <i class="bx bx-hash text-blue-600 text-xl"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">N.º de Reserva</p>
                                <p class="text-lg font-bold text-gray-800" th:text="${reserva.idReserva}">RSV-2025-001</p>
                            </div>
                        </div>

                        <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-xl">
                            <i class="bx bx-user text-green-600 text-xl"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Vecino Responsable</p>
                                <p class="text-lg font-semibold text-gray-800" th:text="${reserva.vecino.nombres + ' ' + reserva.vecino.apellidos}">Juan Pérez García</p>
                            </div>
                        </div>

                        <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-xl">
                            <i class="bx bx-football text-orange-600 text-xl"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Espacio Deportivo</p>
                                <p class="text-lg font-semibold text-gray-800" th:text="${reserva.espacio.nombre}">Cancha de Fútbol Principal</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-xl">
                            <i class="bx bx-calendar text-purple-600 text-xl"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Fecha de Reserva</p>
                                <p class="text-lg font-semibold text-gray-800" th:text="${#temporals.format(reserva.fecha, 'EEEE, dd ''de'' MMMM ''de'' yyyy')}">Sábado, 20 de julio de 2025</p>
                            </div>
                        </div>

                        <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-xl">
                            <i class="bx bx-time text-red-600 text-xl"></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Horario</p>
                                <p class="text-lg font-semibold text-gray-800">
                                    <span th:text="${#temporals.format(reserva.horaInicio, 'h:mm a')}">2:00 PM</span> -
                                    <span th:text="${#temporals.format(reserva.horaFin, 'h:mm a')}">4:00 PM</span>
                                </p>
                            </div>
                        </div>

                        <div class="flex items-center space-x-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
                            <i class="bx bx-money text-green-600 text-xl"></i>
                            <div>
                                <p class="text-sm text-green-700 font-medium">Monto Total a Pagar</p>
                                <p class="text-2xl font-bold text-green-800">
                                    S/ <span th:text="${#numbers.formatDecimal(reserva.costo, 0, 2)}">60.00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Estado de la reserva -->
                <div class="mt-6 p-4 rounded-xl"
                     th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full animate-pulse"
                             th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'bg-green-500' : 'bg-yellow-500'"></div>
                        <div>
                            <p class="text-sm font-medium"
                               th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'text-green-700' : 'text-yellow-700'">
                                Estado actual
                            </p>
                            <p class="text-lg font-semibold"
                               th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'text-green-800' : 'text-yellow-800'"
                               th:text="${reserva.estado.estado}">
                                Pendiente de pago
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Bancaria -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i class="bx bx-credit-card text-indigo-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Datos para el Pago</h2>
                        <p class="text-gray-600">Realice su depósito en la cuenta oficial</p>
                    </div>
                </div>

                <div class="bank-card p-6 text-white mb-6">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <p class="text-blue-200 text-sm">Cuenta Oficial</p>
                            <p class="text-white text-lg font-bold">Municipalidad de San Miguel</p>
                        </div>
                        <div class="text-right">
                            <p class="text-blue-200 text-sm">Banco</p>
                            <p class="text-white font-semibold">Banco de la Nación</p>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-200">N.º de Cuenta:</span>
                            <span class="font-mono text-xl tracking-wider cursor-pointer hover:text-green-300 transition-colors" title="Hacer clic para copiar" onclick="copiarTexto('00-175-054321', this)">00-175-054321</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-200">CCI:</span>
                            <span class="font-mono text-lg cursor-pointer hover:text-green-300 transition-colors" title="Hacer clic para copiar" onclick="copiarTexto('018-175-000175054321-45', this)">018-175-000175054321-45</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-200">Titular:</span>
                            <span class="text-sm">Municipalidad Distrital de San Miguel</span>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex items-start space-x-3">
                        <i class="bx bx-info-circle text-blue-600 text-lg mt-1"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800 mb-2">Instrucciones importantes:</h4>
                            <ul class="text-blue-700 text-sm space-y-1">
                                <li>• Deposite exactamente S/ <span th:text="${#numbers.formatDecimal(reserva.costo, 0, 2)}" class="font-semibold">60.00</span></li>
                                <li>• Indique como concepto: "Reserva N.º <span th:text="${reserva.idReserva}" class="font-mono">RSV-001</span>"</li>
                                <li>• Conserve su voucher de depósito</li>
                                <li>• Suba la foto del voucher en el paso siguiente</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Pasos y Acciones -->
        <div class="lg:col-span-1 space-y-8">

            <!-- Pasos del Proceso -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="bx bx-list-check text-blue-600 mr-3 text-2xl"></i>
                    Proceso de Confirmación
                </h3>

                <div class="payment-steps space-y-4">
                    <div class="step-active rounded-xl p-4 relative z-10">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                                <i class="bx bx-check text-green-600 font-bold"></i>
                            </div>
                            <div>
                                <p class="font-semibold">Reserva creada</p>
                                <p class="text-sm opacity-90">Su solicitud fue registrada</p>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 2 actual - AMARILLO -->
                    <div class="step-pending rounded-xl p-4 relative z-10 border-2 border-dashed border-yellow-300">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                <span class="text-yellow-600 font-bold text-sm">2</span>
                            </div>
                            <div>
                                <p class="font-semibold text-yellow-700">Realizar depósito</p>
                                <p class="text-sm text-yellow-600">En la cuenta indicada abajo</p>
                            </div>
                        </div>
                    </div>

                    <div class="step-pending rounded-xl p-4 relative z-10">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-gray-500 font-bold text-sm">3</span>
                            </div>
                            <div>
                                <p class="font-semibold">Subir comprobante</p>
                                <p class="text-sm">Foto del voucher de pago</p>
                            </div>
                        </div>
                    </div>
                    <!-- Paso 4 dinámico: Revisión del coordinador -->
                    <div class="rounded-xl p-4 relative z-10"
                         th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'step-active' : 'step-pending'">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center"
                                 th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'bg-white':''">
                                <i th:classappend="${reserva.estado.estado == 'Confirmada'} ? 'bx bx-check text-green-600 font-bold' : ''"></i>
                                <span class="text-sm font-bold" th:if="${reserva.estado.estado != 'Confirmada'}">4</span>
                            </div>
                            <div>
                                <p class="font-semibold"
                                   th:class="${reserva.estado.estado == 'Confirmada'} ? 'text-green-700' : ''">
                                    Revisión del coordinador
                                </p>
                                <p class="text-sm"
                                   th:class="${reserva.estado.estado == 'Confirmada'} ? 'text-green-600' : ''"
                                   th:text="${reserva.estado.estado == 'Confirmada'} ? 'Pago validado exitosamente.' : 'Validación del pago'">
                                    Validación del pago
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="step-active rounded-xl p-4 relative z-10" th:if="${reserva.estado.estado == 'Confirmada'}">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                                <i class="bx bx-check text-green-600 font-bold"></i>
                            </div>
                            <div>
                                <p class="font-semibold">¡Reserva confirmada!</p>
                                <p class="text-sm">Lista para usar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones Principales -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Acciones Disponibles</h3>

                <div class="space-y-4">
                    <!-- Botón principal de subir comprobante -->
                    <button id="botonSubirComprobante"
                            onclick="mostrarModalComprobante()"
                            th:data-reserva-id="${reserva.idReserva}"
                            th:data-captura-key="${reserva.capturaKey}"
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center space-x-3">
                        <i class="bx bx-cloud-upload text-xl"></i>
                        <span th:if="${reserva.capturaKey == null}">Subir Comprobante de Pago</span>
                        <span th:if="${reserva.capturaKey != null}">Ver Comprobante Enviado</span>
                    </button>

                    <div class="grid grid-cols-2 gap-3">
                        <a th:href="@{/vecino/mis-reservas}"
                           class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-xl transition-all duration-300 text-center flex items-center justify-center space-x-2 text-sm">
                            <i class="bx bx-list-ul"></i>
                            <span>Mis Reservas</span>
                        </a>

                        <button onclick="window.print()"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-xl transition-all duration-300 text-center flex items-center justify-center space-x-2 text-sm no-print">
                            <i class="bx bx-printer"></i>
                            <span>Imprimir</span>
                        </button>
                    </div>

                    <a th:href="@{/}"
                       class="w-full bg-gray-50 hover:bg-gray-100 text-gray-600 font-medium py-3 px-4 rounded-xl transition-all duration-300 text-center block border border-gray-200">
                        <i class="bx bx-home mr-2"></i>
                        Volver al Inicio
                    </a>
                </div>
            </div>

            <!-- Ayuda -->
            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-6 border border-blue-200">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="bx bx-help-circle text-blue-600 text-lg"></i>
                    </div>
                    <h4 class="font-bold text-blue-800">¿Necesita ayuda?</h4>
                </div>
                <p class="text-blue-700 text-sm mb-4">
                    Si tiene dudas sobre el proceso de pago o necesita asistencia, contáctenos:
                </p>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center space-x-2 text-blue-700">
                        <i class="bx bx-phone"></i>
                        <span>(01) 264-0701</span>
                    </div>
                    <div class="flex items-center space-x-2 text-blue-700">
                        <i class="bx bx-envelope"></i>
                        <span>deportes@munisanmiguel.gob.pe</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante de acción -->
<div class="floating-action no-print" th:if="${reserva.capturaKey == null}">
    <button onclick="mostrarModalComprobante()"
            class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-110 tooltip"
            data-tooltip="¡Suba su comprobante aquí!">
        <i class="bx bx-cloud-upload text-2xl"></i>
    </button>
</div>

<!-- Modal Comprobante Mejorado -->
<div id="modalComprobante" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl relative max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="bx bx-cloud-upload text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Subir Comprobante</h2>
                        <p class="text-gray-600 text-sm">Envíe la foto de su voucher de pago</p>
                    </div>
                </div>
                <button onclick="cerrarModalComprobante()"
                        class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                    <i class="bx bx-x text-gray-600"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <form id="formComprobante" enctype="multipart/form-data">
                <input type="hidden" name="idReserva" th:value="${reserva.idReserva}">

                <div class="mb-6">
                    <div id="dropzonePreview" class="border-2 border-dashed border-blue-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all duration-300">
                        <div id="uploadPrompt">
                            <i class="bx bx-cloud-upload text-blue-400 text-4xl mb-4"></i>
                            <p class="text-gray-600 mb-2">Arrastra tu imagen aquí</p>
                            <p class="text-gray-500 text-sm">o haz clic para seleccionar archivo</p>
                            <p class="text-gray-400 text-xs mt-2">Formatos: JPG, PNG, PDF (máx. 5MB)</p>
                        </div>
                        <img id="previewImg" class="mt-4 mx-auto max-h-64 hidden rounded-lg shadow-md" />
                        <input id="comprobanteInput" type="file" name="comprobante" accept="image/*,.pdf" class="hidden" />
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <div class="flex items-start space-x-3">
                        <i class="bx bx-info-circle text-blue-600 text-lg mt-1"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800 mb-2">Requisitos del comprobante:</h4>
                            <ul class="text-blue-700 text-sm space-y-1">
                                <li>• Imagen clara y legible del voucher</li>
                                <li>• Debe mostrar el monto de S/ <span th:text="${#numbers.formatDecimal(reserva.costo, 0, 2)}" class="font-semibold">60.00</span></li>
                                <li>• Incluir fecha y hora de la transacción</li>
                                <li>• Formato JPG, PNG o PDF</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <button type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center space-x-3">
                    <i class="bx bx-send text-lg"></i>
                    <span>Enviar Comprobante</span>
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/boleta-script.js}"></script>
<script>
    setInterval(() => {
        fetch(`/vecino/estado-reserva/${idReserva}`)
            .then(response => response.json())
            .then(data => {
                if (data.estado === "Confirmada") {
                    document.querySelector("#badgeEstado").classList.remove("bg-yellow-500");
                    document.querySelector("#badgeEstado").classList.add("bg-green-500");
                    document.querySelector("#badgeEstado").innerText = "¡Reservado!";
                }
            });
    }, 5000); // Verifica cada 5 segundos
</script>
</body>
</html>