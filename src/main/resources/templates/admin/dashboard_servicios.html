<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org"
      lang="es"
      class="light-style layout-navbar-fixed layout-menu-fixed layout-compact"
      dir="ltr"
      data-theme="theme-semi-dark"
      data-assets-path="/"
      data-template="vertical-menu-template-semi-dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Dashboard de Servicios</title>
  <meta name="description" content="Most Powerful & Comprehensive Bootstrap 5 Admin Dashboard built for developers!" />
  <meta name="keywords" content="dashboard, bootstrap 5 dashboard, bootstrap 5 design, bootstrap 5" />
  <link rel="canonical" href="https://themeselection.com/item/sneat-dashboard-pro-bootstrap/" />

  <link rel="icon" type="image/x-icon" th:href="@{/img/icono.ico}" />

  <link rel="preconnect" href="https://fonts.googleapis.com/" />
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" th:href="@{/vendor/fonts/boxicons.css}" />
  <link rel="stylesheet" th:href="@{/vendor/fonts/fontawesome.css}" />
  <link rel="stylesheet" th:href="@{/vendor/fonts/flag-icons.css}" />

  <link rel="stylesheet" th:href="@{/vendor/css/rtl/core.css}" class="template-customizer-core-css" />
  <link rel="stylesheet" th:href="@{/vendor/css/rtl/theme-semi-dark.css}" class="template-customizer-theme-css" />
  <link rel="stylesheet" th:href="@{/css/demo.css}" />

  <link rel="stylesheet" th:href="@{/vendor/libs/perfect-scrollbar/perfect-scrollbar.css}" />
  <link rel="stylesheet" th:href="@{/vendor/libs/typeahead-js/typeahead.css}" />
  <link rel="stylesheet" th:href="@{/vendor/libs/datatables-bs5/datatables.bootstrap5.css}" />
  <link rel="stylesheet" th:href="@{/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css}" />
  <link rel="stylesheet" th:href="@{/vendor/libs/datatables-checkboxes-jquery/datatables.checkboxes.css}" />

  <link rel="stylesheet" th:href="@{/vendor/css/pages/page-profile.css}" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script th:src="@{/vendor/js/helpers.js}"></script>
  <script th:src="@{/js/config.js}"></script>

  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 10% 20%, rgba(216, 241, 230, 0.46) 0%, rgba(255, 255, 255, 0.1) 90.2%),
        linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, rgba(201, 215, 255, 0.2) 100%);
      pointer-events: none;
      z-index: -1;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 15px;
      box-shadow:
        0 10px 20px rgba(0,0,0,0.08),
        0 0 0 1px rgba(255,255,255,0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #696cff, #ff4d4d);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .card:hover::before {
      opacity: 1;
    }
    .card:hover {
      transform: translateY(-5px) scale(1.005);
      box-shadow:
        0 20px 30px rgba(0,0,0,0.12),
        0 0 0 1px rgba(255,255,255,0.2);
    }
    .form-control {
      border-radius: 10px;
      border: 2px solid rgba(105,108,255,0.1);
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.9);
    }
    .form-control:focus {
      transform: translateY(-2px);
      border-color: rgba(105,108,255,0.5);
      box-shadow:
        0 5px 15px rgba(105,108,255,0.1),
        0 0 0 3px rgba(105,108,255,0.1);
    }
    .btn {
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      font-weight: 500;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      transform: translateX(-100%);
      transition: transform 0.6s;
    }
    .btn:hover::before {
      transform: translateX(100%);
    }
    .btn-primary {
      background: linear-gradient(45deg, #696cff, #8789ff);
      box-shadow: 0 4px 15px rgba(105,108,255,0.3);
    }
    @media (max-width: 768px) {
      .card {
        border-radius: 10px;
      }
    }
  </style>
</head>

<body>

<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    <div th:replace="~{fragments/sidebar-admin :: sidebarAdmin('dashboard', 'dashboard-servicios')}"></div>

    <div class="layout-page">
      <div th:replace="~{fragments/navbar-admin :: navbarAdmin}"></div>

      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">
          <div class="row">
            <div class="col-sm-6 col-lg-3 mb-4">
              <div class="card card-border-shadow-primary h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2 pb-1">
                    <div class="avatar me-2">
                      <span class="avatar-initial rounded bg-label-primary"><i class="bx bx-water"></i></span>
                    </div>
                    <h4 class="ms-1 mb-0" th:text="${cantidadesPorTipo['Piscina']}">0</h4>
                  </div>
                  <p class="mb-1">Piscinas</p>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-4">
              <div class="card card-border-shadow-danger h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2 pb-1">
                    <div class="avatar me-2">
                      <span class="avatar-initial rounded bg-label-danger"><i class='bx bx-football'></i></span>
                    </div>
                    <h4 class="ms-1 mb-0" th:text="${cantidadesPorTipo['Cancha de fútbol - Loza']}">0</h4>
                  </div>
                  <p class="mb-1">Cancha de fútbol<br>(Loza)</p>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-4">
              <div class="card card-border-shadow-info h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2 pb-1">
                    <div class="avatar me-2">
                      <span class="avatar-initial rounded bg-label-info"><i class='bx bx-football'></i></span>
                    </div>
                    <h4 class="ms-1 mb-0" th:text="${cantidadesPorTipo['Cancha de fútbol - Grass Sintético']}">0</h4>
                  </div>
                  <p class="mb-1">Cancha de fútbol<br>(Grass Sintético)</p>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-4">
              <div class="card card-border-shadow-success h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2 pb-1">
                    <div class="avatar me-2">
                      <span class="avatar-initial rounded bg-label-success"><i class="bx bx-run"></i></span>
                    </div>
                    <h4 class="ms-1 mb-0" th:text="${cantidadesPorTipo['Pista de Atletismo']}">0</h4>
                  </div>
                  <p class="mb-1">Pista de Atletismo</p>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-4">
            <div class="col-12">
              <div class="card flex-grow-1 h-100">
                <div class="card-header pb-2">
                  <div class="card-title mb-0">
                    <h5 class="m-0">Reservas por Tipo de Espacio</h5>
                  </div>
                </div>
                <div class="card-body d-flex flex-column">
                  <div style="width:100%;min-height:220px;">
                    <canvas id="reservasBarChart"></canvas>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table card-table mb-0">
                      <thead>
                      <tr>
                        <th>Tipo de Espacio</th>
                        <th class="text-end">Cantidad</th>
                        <th class="text-end">Total Reservas</th>
                        <th class="text-end">Porcentaje de Uso</th>
                      </tr>
                      </thead>
                      <tbody class="table-border-bottom-0">
                      <tr th:each="tipo : ${#lists.toList(cantidadesPorTipo.keySet())}">
                        <td class="w-50 ps-0">
                          <div class="d-flex justify-content-start align-items-center">
                            <div class="me-2">
                              <i th:switch="${tipo}">
                                <i th:case="'Piscina'" class="bx bx-water"></i>
                                <i th:case="'Cancha de fútbol - Grass Sintético'" class="bx bx-football"></i>
                                <i th:case="'Cancha de fútbol - Loza'" class="bx bx-football"></i>
                                <i th:case="*" class="bx bx-run"></i>
                              </i>
                            </div>
                            <h6 class="mb-0 fw-normal" th:text="${tipo}"></h6>
                          </div>
                        </td>
                        <td class="text-end pe-0 text-nowrap">
                          <h6 class="mb-0" th:text="${cantidadesPorTipo.get(tipo)}">0</h6>
                        </td>
                        <td class="text-end pe-0 text-nowrap">
                          <h6 class="mb-0" th:text="${totalReservasPorTipo.get(tipo)}">0</h6>
                        </td>
                        <td class="text-end pe-0">
                            <span class="fw-medium"
                                  th:with="porcentaje=${cantidadesPorTipo.get(tipo) > 0 ?
                                          (totalReservasPorTipo.get(tipo) * 100.0 / cantidadesPorTipo.get(tipo)) : 0}"
                                  th:text="${#numbers.formatDecimal(porcentaje, 1, 2) + '%'}">0%</span>
                        </td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card flex-grow-1 h-100">
                <div class="card-header pb-2">
                  <div class="card-title mb-0">
                    <h5 class="m-0 me-2">Tendencias de Reservas en el Tiempo</h5>
                    <small class="text-muted">Total de reservas</small>
                  </div>
                </div>
                <div class="card-body d-flex flex-column">
                  <div style="width:100%;min-height:220px;">
                    <canvas id="reservationTrendsChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script th:inline="javascript">
          document.addEventListener('DOMContentLoaded', function () {
            // --- Gráfico de barras de reservas por tipo de espacio ---
            const barCtx = document.getElementById('reservasBarChart').getContext('2d');
            const tipos = /*[[${#lists.toList(cantidadesPorTipo.keySet())}]]*/ [];

            // Función para acortar nombres en móviles
            const acortarNombre = (nombre) => {
              if (window.innerWidth < 768) { // Para móviles
                return nombre
                        .replace('Cancha de fútbol - ', 'C. Fútbol ')
                        .replace('Pista de Atletismo', 'P. Atletismo');
              }
              return nombre;
            };

            const tiposAcortados = tipos.map(acortarNombre);
            const cantidades = /*[[${#lists.toList(cantidadesPorTipo.values())}]]*/ [];
            const totalReservasPorTipo = /*[[${totalReservasPorTipo}]]*/ {};
            const totalReservas = tipos.map(tipo => totalReservasPorTipo[tipo] || 0);

            new Chart(barCtx, {
              type: 'bar',
              data: {
                labels: tiposAcortados,
                datasets: [
                  {
                    label: 'Cantidad de Espacios',
                    data: cantidades,
                    backgroundColor: 'rgba(78, 115, 223, 0.8)',
                    borderRadius: 8,
                    maxBarThickness: 32
                  },
                  {
                    label: 'Total Reservas(Confirmadas)',
                    data: totalReservas,
                    backgroundColor: 'rgba(28, 200, 138, 0.8)',
                    borderRadius: 8,
                    maxBarThickness: 32
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                  padding: {
                    top: 10,
                    bottom: window.innerWidth < 768 ? 20 : 0, // Más espacio en móviles
                    left: 0,
                    right: 0
                  }
                },
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                      font: {
                        size: window.innerWidth < 768 ? 10 : 13 // Fuente más pequeña en móviles
                      }
                    }
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false,
                    titleFont: {
                      size: window.innerWidth < 768 ? 10 : 12
                    },
                    bodyFont: {
                      size: window.innerWidth < 768 ? 10 : 12
                    }
                  }
                },
                scales: {
                  x: {
                    stacked: false,
                    ticks: {
                      maxRotation: window.innerWidth < 768 ? 45 : 30, // Más rotación en móviles
                      minRotation: window.innerWidth < 768 ? 45 : 0,
                      font: {
                        size: window.innerWidth < 768 ? 8 : 13 // Fuente más pequeña en móviles
                      }
                    }
                  },
                  y: {
                    beginAtZero: true,
                    ticks: {
                      font: {
                        size: window.innerWidth < 768 ? 10 : 13 // Fuente más pequeña en móviles
                      }
                    }
                  }
                }
              }
            });

            // --- Gráfico de líneas de tendencias de reservas ---
            const ctx = document.getElementById('reservationTrendsChart').getContext('2d');
            const tendencias = /*[[${tendencias}]]*/ [];

            function formatearFecha(anio, mes, dia) {
              const mm = mes.toString().padStart(2, '0');
              const dd = dia.toString().padStart(2, '0');
              return `${anio}-${mm}-${dd}`;
            }

            // Obtener todas las fechas únicas ordenadas
            const fechasSet = new Set();
            tendencias.forEach(t => {
              const fechaStr = formatearFecha(t.anio, t.mes, t.dia);
              fechasSet.add(fechaStr);
            });
            const fechas = Array.from(fechasSet).sort();

            // Obtener todos los tipos de espacio presentes en tendencias
            const tiposTendenciaSet = new Set();
            tendencias.forEach(t => tiposTendenciaSet.add(t.tipoEspacio));
            // Si no hay tipos en tendencias, usar los tipos del resumen para mostrar todos los tipos
            let tiposTendencia = Array.from(tiposTendenciaSet);
            if (tiposTendencia.length === 0 && tipos.length > 0) {
              tiposTendencia = tipos;
            }

            // Construir los datos por tipo de espacio
            const datosPorTipo = {};
            tiposTendencia.forEach(tipo => {
              datosPorTipo[tipo] = fechas.map(fecha => {
                const item = tendencias.find(t => {
                  const f = formatearFecha(t.anio, t.mes, t.dia);
                  return t.tipoEspacio === tipo && f === fecha;
                });
                return item ? item.totalReservas : 0;
              });
            });

            // Colores para cada tipo de espacio
            const colores = [
              '#4e73df', // azul
              '#1cc88a', // verde
              '#f6c23e', // amarillo
              '#e74a3b', // rojo
              '#36b9cc', // celeste
              '#858796', // gris
              '#fd7e14', // naranja
              '#6f42c1'  // morado
            ];
            const datasets = tiposTendencia.map((tipo, i) => ({
              label: tipo,
              data: datosPorTipo[tipo],
              borderColor: colores[i % colores.length],
              backgroundColor: colores[i % colores.length] + '33',
              fill: false,
              tension: 0.3,
              pointRadius: 3,
              pointHoverRadius: 6,
              borderWidth: 2
            }));

            new Chart(ctx, {
              type: 'line',
              data: {
                labels: fechas,
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 10, bottom: 0, left: 0, right: 0 } },
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                      font: {
                        size: window.innerWidth < 768 ? 10 : 13 // Smaller font for mobile
                      }
                    }
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false,
                    titleFont: {
                      size: window.innerWidth < 768 ? 10 : 12
                    },
                    bodyFont: {
                      size: window.innerWidth < 768 ? 10 : 12
                    }
                  }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Reservas'
                    },
                    ticks: {
                      font: {
                        size: window.innerWidth < 768 ? 10 : 13 // Smaller font for mobile
                      }
                    }
                  },
                  x: {
                    title: {
                      display: true,
                      text: 'Fecha'
                    },
                    ticks: {
                      maxRotation: window.innerWidth < 768 ? 90 : 45, // Rotate more for mobile if many dates
                      minRotation: window.innerWidth < 768 ? 90 : 0,
                      font: {
                        size: window.innerWidth < 768 ? 8 : 13 // Smaller font for mobile dates
                      },
                      autoSkip: true, // Automatically skip labels if too crowded
                      maxTicksLimit: window.innerWidth < 768 ? 8 : 15 // Limit number of ticks for mobile
                    }
                  }
                }
              }
            });
          });
        </script>

        <div class="content-backdrop fade"></div>
      </div>
    </div>
  </div>

  <div class="layout-overlay layout-menu-toggle"></div>

  <div class="drag-target"></div>
</div>
<script th:src="@{/vendor/libs/jquery/jquery.js}"></script>
<script th:src="@{/vendor/libs/popper/popper.js}"></script>
<script th:src="@{/vendor/js/bootstrap.js}"></script>
<script th:src="@{/vendor/libs/perfect-scrollbar/perfect-scrollbar.js}"></script>
<script th:src="@{/vendor/libs/hammer/hammer.js}"></script>
<script th:src="@{/vendor/libs/i18n/i18n.js}"></script>
<script th:src="@{/vendor/libs/typeahead-js/typeahead.js}"></script>
<script th:src="@{/vendor/js/menu.js}"></script>

<script th:src="@{/vendor/libs/datatables-bs5/datatables-bootstrap5.js}"></script>

<script th:src="@{/js/main.js}"></script>

<script th:src="@{/js/app-user-view-account.js}"></script>
</body>
</html>